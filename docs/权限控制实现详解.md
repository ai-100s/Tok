# TOK æƒé™æ§åˆ¶å®ç°è¯¦è§£

## æ¦‚è¿°

TOK åº”ç”¨éœ€è¦å¤šç§ç³»ç»Ÿæƒé™æ¥å®ç°è¯­éŸ³è½¬å½•åŠŸèƒ½ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†æƒé™æ§åˆ¶çš„å®ç°æœºåˆ¶ï¼ŒåŒ…æ‹¬æƒé™æ£€æŸ¥ã€è¯·æ±‚æµç¨‹ã€çŠ¶æ€ç®¡ç†å’Œç”¨æˆ·ç•Œé¢é›†æˆã€‚

## æƒé™ç±»å‹

TOK éœ€è¦ä»¥ä¸‹ä¸‰ç§æ ¸å¿ƒæƒé™ï¼š

1. **éº¦å…‹é£æƒé™** - å½•åˆ¶è¯­éŸ³
2. **è¾…åŠ©åŠŸèƒ½æƒé™** - ç›‘å¬å…¨å±€çƒ­é”®
3. **å±å¹•å½•åˆ¶æƒé™** - æˆªå±è¿›è¡Œ AI åˆ†æï¼ˆå¯é€‰ï¼‰

## æƒé™çŠ¶æ€æ¨¡å‹

### PermissionStatus æšä¸¾

```swift
enum PermissionStatus: Equatable {
  case notDetermined  // æœªç¡®å®šçŠ¶æ€
  case granted        // å·²æˆæƒ
  case denied         // å·²æ‹’ç»
}
```

è¿™ä¸ªç®€æ´çš„æšä¸¾æ¶µç›–äº†æ‰€æœ‰æƒé™çš„ä¸‰ç§åŸºæœ¬çŠ¶æ€ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†ä¸åŒç±»å‹çš„æƒé™ã€‚

## é…ç½®æ–‡ä»¶è®¾ç½®

### Info.plist æƒé™æè¿°

```xml
<key>NSAccessibilityUsageDescription</key>
<string>Tok needs accessibility access to monitor keyboard events for hotkey detection.</string>

<key>NSScreenCaptureDescription</key>
<string>Tok needs screen recording permission to capture screenshots for AI analysis and context understanding.</string>
```

### Entitlements æ–‡ä»¶

```xml
<key>com.apple.security.automation.apple-events</key>
<true/>
<key>com.apple.security.device.audio-input</key>
<true/>
<key>com.apple.security.device.camera</key>
<true/>
<key>com.apple.security.automation.screen-capture</key>
<true/>
```

## æƒé™å®ç°è¯¦è§£

### 1. éº¦å…‹é£æƒé™

#### æƒé™æ£€æŸ¥

```swift
private func checkMicrophonePermission() async -> PermissionStatus {
  switch AVCaptureDevice.authorizationStatus(for: .audio) {
  case .authorized:
    return .granted
  case .denied, .restricted:
    return .denied
  case .notDetermined:
    return .notDetermined
  @unknown default:
    return .denied
  }
}
```

#### æƒé™è¯·æ±‚

```swift
private func requestMicrophonePermissionImpl() async -> Bool {
  await withCheckedContinuation { continuation in
    AVCaptureDevice.requestAccess(for: .audio) { granted in
      continuation.resume(returning: granted)
    }
  }
}
```

**å®ç°ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ `AVCaptureDevice` API è¿›è¡Œæƒé™ç®¡ç†
- å¼‚æ­¥è¯·æ±‚ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
- ä½¿ç”¨ `withCheckedContinuation` å°†å›è°ƒè½¬æ¢ä¸º async/await æ¨¡å¼

#### éŸ³é¢‘è®¾å¤‡ç®¡ç†

```swift
/// è·å–æ‰€æœ‰å¯ç”¨çš„éŸ³é¢‘è¾“å…¥è®¾å¤‡
func getAvailableInputDevices() async -> [AudioInputDevice] {
  let devices = getAllAudioDevices()
  var inputDevices: [AudioInputDevice] = []
  
  for device in devices {
    if deviceHasInput(deviceID: device) {
      if let name = getDeviceName(deviceID: device) {
        inputDevices.append(AudioInputDevice(id: String(device), name: name))
      }
    }
  }
  
  return inputDevices
}

/// è®¾ç½®æŒ‡å®šè®¾å¤‡ä¸ºé»˜è®¤è¾“å…¥è®¾å¤‡
private func setInputDevice(deviceID: AudioDeviceID) {
  var device = deviceID
  let size = UInt32(MemoryLayout<AudioDeviceID>.size)
  var address = AudioObjectPropertyAddress(
    mSelector: kAudioHardwarePropertyDefaultInputDevice,
    mScope: kAudioObjectPropertyScopeGlobal,
    mElement: kAudioObjectPropertyElementMain
  )
  
  let status = AudioObjectSetPropertyData(
    AudioObjectID(kAudioObjectSystemObject),
    &address,
    0,
    nil,
    size,
    &device
  )
}
```

**è®¾å¤‡ç®¡ç†ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ Core Audio API æšä¸¾å’Œç®¡ç†éŸ³é¢‘è®¾å¤‡
- æ”¯æŒåŠ¨æ€è®¾å¤‡åˆ‡æ¢
- ç¼“å­˜è®¾å¤‡ä¿¡æ¯ä»¥æé«˜æ€§èƒ½
- å®šæœŸåˆ·æ–°è®¾å¤‡åˆ—è¡¨ï¼ˆæ¯ 3 åˆ†é’Ÿï¼‰

### 2. è¾…åŠ©åŠŸèƒ½æƒé™

#### æƒé™æ£€æŸ¥

```swift
private func checkAccessibilityPermission() -> PermissionStatus {
  let options = [kAXTrustedCheckOptionPrompt.takeUnretainedValue() as String: false] as CFDictionary
  let trusted = AXIsProcessTrustedWithOptions(options)
  return trusted ? .granted : .denied
}
```

#### æƒé™è¯·æ±‚

```swift
case .requestAccessibilityPermission:
  return .run { send in
    // æ˜¾ç¤ºç³»ç»Ÿæƒé™å¯¹è¯æ¡†
    let options = [kAXTrustedCheckOptionPrompt.takeUnretainedValue() as String: true] as CFDictionary
    _ = AXIsProcessTrustedWithOptions(options)

    // è‡ªåŠ¨æ‰“å¼€ç³»ç»Ÿè®¾ç½®
    NSWorkspace.shared.open(
      URL(string: "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility")!
    )

    // è½®è¯¢æ£€æŸ¥æƒé™çŠ¶æ€
    for await _ in self.clock.timer(interval: .seconds(0.5)) {
      let newStatus = checkAccessibilityPermission()
      await send(.setAccessibilityPermission(newStatus))

      if newStatus == .granted {
        break
      }
    }
  }
```

**å®ç°ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ `AXIsProcessTrustedWithOptions` æ£€æŸ¥å’Œè¯·æ±‚æƒé™
- è‡ªåŠ¨æ‰“å¼€ç³»ç»Ÿè®¾ç½®é¡µé¢
- æ¯ 0.5 ç§’è½®è¯¢æ£€æŸ¥æƒé™çŠ¶æ€
- è·å¾—æƒé™åè‡ªåŠ¨åœæ­¢è½®è¯¢

#### çƒ­é”®ç›‘å¬å¯åŠ¨

```swift
case let .setAccessibilityPermission(status):
  state.accessibilityPermission = status
  if status == .granted {
    return .run { _ in
      await keyEventMonitor.startMonitoring()
    }
  } else {
    return .none
  }
```

æƒé™è·å¾—åç«‹å³å¯åŠ¨çƒ­é”®ç›‘å¬æœåŠ¡ã€‚

### 3. å±å¹•å½•åˆ¶æƒé™

#### æƒé™æ£€æŸ¥ä¸è¯·æ±‚

```swift
case .requestScreenCapturePermission:
  return .run { send in
    do {
      // å°è¯•æˆªå±ä»¥è§¦å‘æƒé™è¯·æ±‚
      _ = try await screenCapture.captureScreen()
      await send(.screenCapturePermissionUpdated(.granted))
    } catch {
      await send(.screenCapturePermissionUpdated(.denied))
    }
  }
```

#### å±å¹•æˆªå›¾å®ç°

```swift
func captureScreen() async throws -> Data {
  // è·å–æ‰€æœ‰å¯ç”¨å†…å®¹
  let content = try await SCShareableContent.excludingDesktopWindows(false, onScreenWindowsOnly: true)
  
  // è·å–ä¸»æ˜¾ç¤ºå™¨
  guard let mainDisplay = content.displays.first else {
    throw NSError(domain: "ScreenCaptureClient", code: -4,
                 userInfo: [NSLocalizedDescriptionKey: "No displays available"])
  }
  
  // åˆ›å»ºå†…å®¹è¿‡æ»¤å™¨
  let filter = SCContentFilter(display: mainDisplay, excludingWindows: [])
  
  // é…ç½®æˆªå›¾è®¾ç½®
  let config = SCStreamConfiguration()
  config.width = Int(mainDisplay.frame.width)
  config.height = Int(mainDisplay.frame.height)
  config.pixelFormat = kCVPixelFormatType_32BGRA
  config.showsCursor = true
  
  // æ‰§è¡Œæˆªå›¾
  let screenshot = try await SCScreenshotManager.captureImage(
    contentFilter: filter,
    configuration: config
  )
  
  return try convertCGImageToPNG(screenshot)
}
```

**å®ç°ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ `ScreenCaptureKit` æ¡†æ¶
- æ”¯æŒå…¨å±å’Œæ´»åŠ¨çª—å£æˆªå›¾
- é€šè¿‡å°è¯•æˆªå›¾æ¥è§¦å‘æƒé™è¯·æ±‚
- è‡ªåŠ¨å¤„ç†æƒé™çŠ¶æ€æ›´æ–°

## çŠ¶æ€ç®¡ç†

### æƒé™çŠ¶æ€å­˜å‚¨

```swift
@ObservableState
struct State {
  // æƒé™çŠ¶æ€
  var microphonePermission: PermissionStatus = .notDetermined
  var accessibilityPermission: PermissionStatus = .notDetermined
  var screenCapturePermission: PermissionStatus = .notDetermined
  
  // å…¶ä»–ç›¸å…³çŠ¶æ€
  var availableInputDevices: [AudioInputDevice] = []
}
```

### æƒé™æ£€æŸ¥æµç¨‹

```swift
case .checkPermissions:
  return .merge(
    .run { send in
      let currentStatus = await checkMicrophonePermission()
      await send(.setMicrophonePermission(currentStatus))
    },
    .run { send in
      let currentStatus = checkAccessibilityPermission()
      await send(.setAccessibilityPermission(currentStatus))
    }
  )
```

ä½¿ç”¨ `.merge` å¹¶è¡Œæ£€æŸ¥å¤šä¸ªæƒé™ï¼Œæé«˜æ•ˆç‡ã€‚

## ç”¨æˆ·ç•Œé¢é›†æˆ

### æƒé™çŠ¶æ€æ˜¾ç¤º

```swift
switch store.microphonePermission {
case .granted:
  Label("Granted", systemImage: "checkmark.circle.fill")
    .foregroundColor(.green)
case .denied:
  Button("Request Permission") {
    store.send(.requestMicrophonePermission)
  }
  .buttonStyle(.borderedProminent)
case .notDetermined:
  Button("Request Permission") {
    store.send(.requestMicrophonePermission)
  }
  .buttonStyle(.bordered)
}
```

### å¼•å¯¼æµç¨‹

åº”ç”¨åŒ…å«å®Œæ•´çš„æƒé™å¼•å¯¼æµç¨‹ï¼š

1. **æ¨¡å‹é€‰æ‹©** - é€‰æ‹©è½¬å½•æ¨¡å‹
2. **éº¦å…‹é£æƒé™** - è¯·æ±‚éº¦å…‹é£è®¿é—®
3. **è¾…åŠ©åŠŸèƒ½æƒé™** - è¯·æ±‚çƒ­é”®ç›‘å¬æƒé™
4. **å±å¹•å½•åˆ¶æƒé™** - å¯é€‰çš„å±å¹•åˆ†æåŠŸèƒ½
5. **çƒ­é”®è®¾ç½®** - é…ç½®å½•éŸ³çƒ­é”®
6. **åŠŸèƒ½æµ‹è¯•** - æµ‹è¯•å®Œæ•´åŠŸèƒ½

### æƒé™çŠ¶æ€è§†å›¾

```swift
private func permissionStatusView(status: PermissionStatus, grantedText: String, deniedText: String) -> some View {
  HStack(spacing: 12) {
    Image(systemName: status == .granted ? "checkmark.circle.fill" : "exclamationmark.circle.fill")
      .foregroundColor(status == .granted ? .green : .orange)
    
    Text(status == .granted ? grantedText : deniedText)
      .fontWeight(.medium)
    
    Spacer()
  }
  .padding(12)
  .background(status == .granted ? Color.green.opacity(0.1) : Color.orange.opacity(0.1))
  .cornerRadius(8)
}
```

## æœ€ä½³å®è·µ

### 1. æƒé™æ£€æŸ¥æ—¶æœº

- **åº”ç”¨å¯åŠ¨æ—¶** - æ£€æŸ¥æ‰€æœ‰æƒé™çŠ¶æ€
- **åŠŸèƒ½ä½¿ç”¨å‰** - ç¡®ä¿ç›¸å…³æƒé™å·²è·å¾—
- **è®¾ç½®é¡µé¢æ‰“å¼€æ—¶** - åˆ·æ–°æƒé™çŠ¶æ€

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- **æ¸…æ™°çš„æƒé™è¯´æ˜** - è§£é‡Šæƒé™ç”¨é€”å’Œå¥½å¤„
- **ä¼˜é›…çš„é™çº§** - éƒ¨åˆ†æƒé™ç¼ºå¤±æ—¶ä»å¯ä½¿ç”¨æ ¸å¿ƒåŠŸèƒ½
- **è‡ªåŠ¨é‡è¯•** - æƒé™è·å¾—åè‡ªåŠ¨å¯ç”¨ç›¸å…³åŠŸèƒ½

### 3. é”™è¯¯å¤„ç†

- **æƒé™è¢«æ‹’ç»** - æä¾›æ‰‹åŠ¨è®¾ç½®æŒ‡å¯¼
- **ç³»ç»Ÿé™åˆ¶** - æä¾›æ›¿ä»£æ–¹æ¡ˆ
- **æƒé™å˜æ›´** - åŠ¨æ€å“åº”æƒé™çŠ¶æ€å˜åŒ–

### 4. æ€§èƒ½ä¼˜åŒ–

- **è®¾å¤‡åˆ—è¡¨ç¼“å­˜** - å‡å°‘é¢‘ç¹çš„è®¾å¤‡æŸ¥è¯¢
- **å¼‚æ­¥æƒé™æ£€æŸ¥** - é¿å…é˜»å¡ä¸»çº¿ç¨‹
- **åˆç†çš„è½®è¯¢é—´éš”** - å¹³è¡¡å“åº”æ€§å’Œæ€§èƒ½

## è°ƒè¯•å’Œæµ‹è¯•

### æƒé™é‡ç½®

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡ç½®æƒé™ï¼š

```bash
# é‡ç½®æ‰€æœ‰æƒé™
tccutil reset All com.yourcompany.tok

# é‡ç½®ç‰¹å®šæƒé™
tccutil reset Microphone com.yourcompany.tok
tccutil reset Accessibility com.yourcompany.tok
tccutil reset ScreenCapture com.yourcompany.tok
```

### æ—¥å¿—è®°å½•

åº”ç”¨åŒ…å«è¯¦ç»†çš„æƒé™ç›¸å…³æ—¥å¿—ï¼š

```swift
print("ğŸ™ï¸ [TIMING] Recording start requested at: \(startTime.timeIntervalSince1970)")
print("[ScreenCaptureClient] Attempting to capture active windowâ€¦")
TokLogger.log("OpenAI API key validation successful")
```

## æ€»ç»“

TOK çš„æƒé™æ§åˆ¶å®ç°å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **å®Œæ•´çš„æƒé™è¦†ç›–** - æ¶µç›–æ‰€æœ‰å¿…éœ€çš„ç³»ç»Ÿæƒé™
2. **ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†** - ä½¿ç”¨ä¸€è‡´çš„æƒé™çŠ¶æ€æ¨¡å‹
3. **ä¼˜é›…çš„ç”¨æˆ·ä½“éªŒ** - æ¸…æ™°çš„å¼•å¯¼æµç¨‹å’ŒçŠ¶æ€åé¦ˆ
4. **é«˜æ•ˆçš„å®ç°** - å¼‚æ­¥å¤„ç†å’Œæ™ºèƒ½ç¼“å­˜
5. **å¥å£®çš„é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸æƒ…å†µå¤„ç†

è¿™ç§è®¾è®¡ç¡®ä¿äº†åº”ç”¨åœ¨å„ç§æƒé™çŠ¶æ€ä¸‹éƒ½èƒ½æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶ä¿æŒä»£ç çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚ 